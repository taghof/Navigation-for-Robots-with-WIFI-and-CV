%\documentclass[12pt,a4paper,twoside,openright,fleqn]{memoir}
\documentclass[10pt]{article}
\usepackage[danish]{babel}
\usepackage[ansinew]{inputenc}
\usepackage{graphicx}
\usepackage{framed}
\usepackage{subfig}
\usepackage{listings}
\usepackage{natbib}
\usepackage{titleref}

\begin{document} 
\newenvironment{nb}
   {\begin{framed}\begin{quotation}}
   {\end{framed}\end{quotation}}
%\newcommand{\oversaet}[1]{(\textit{#1})}
\newcommand{\uri}[1]{#1}
\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\todo}[1]{\textbf{#1}}

\title{Master Thesis}
\author{Thomas Thyregod 20051688\\ Morten Daugaard 20051715\\ \texttt{
    tysse, taghof }@cs.au.dk\\\\ Department of Computer Science,
  University of Aarhus\\ Aabogade 34, 8200 Aarhus N, Denmark\\\\ 
\hline\\
\vspace{4cm}\\
\makeatletter
\texttt{Semi Autonomous Indoor}\\ %Indoor? - nogle udendørs robotter
                                %heller ikke bruge gps, for dyrt i
                                %præcision... 
\texttt{Navigation for Arial Robots}\\
\vspace{4cm}\\
\hline\\
}
\date{\today}
\maketitle
\newpage

\pagestyle{headings}

\section*{Abstract}
In english...

\section*{Resume}
Indeholder og gennemgår i det følgende (på dansk).
\todo{hello}

\pagebreak

\tableofcontents

\pagebreak

\section{Introduktion}
\label{sec:introduktion}
\subsection{området, teknologi}
-Kort intro hvad vil vi gøre...

-problem domæne,
-introduktion til andres arbejde / resultater, 
-hvad bygger vi videre på (hvis arbejde), 
-hvad er vores antagelser til at starte med

Introduktion til rapportens arbejde, hvilke afsnit der gennemgåes og hvad afsnit indeholder.
%\titleref{sec:AR.Drone}


\pagebreak

\section{Motivation}
\label{sec:motivation}
Hvorfor i det hele taget begive sig herudi noget der ikke lader sig gøre
-Hvem vil vores resultater komme til gode
-anvendelses områder
-hvorfor er det bedre/billigere med vores løsninger
-Cost efficiency?

\section{Teseformulering}
\label{sec:tese}
HVAD er det præcis vi vil vise eller afvise?! 
nærmest punktform, - punkter kan konfirmeres eller afvises i konklusionen. 

\section{Metode}
\label{sec:metode}
Antagelser, problemdomæne formuleret i introduktionen sektion \ref{sec:introduktion}.
(Lavpraktisk:)
- hvilke værktøjer vil vi tage i brug AR.Dronen, PC, joystick/controller, Python, => hvorfor, argumentation.
   tage AR.Dronen gå fra at bruge den som en fjernstyrbar enhed til at gøre den til en næsten selvstændig semi autonom enhed.

- hvad er miljøet, Vi begrænser anvendelses-/test-området, hvorfor argumentation er simplificering for os selv, fokusere på det relevante, hvad er det(relevante)?! - pege tilbage på tesenformuleringen sektion \ref{sec:tese}.

-Hvordan vil vi faktisk teste vores tese? - arbejde går imod at lave en testopstilling, hvad skal der til for at opstillingen virker? framework, processor-kraft båndbredde

Højniveau?:
- er der noget højt,... abstraktion?



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     AR.Drone - section
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{AR.Drone}
\label{sec:AR.Drone}
AR.Drone er en quadrokopter fremstillet og udviklet af det franske
firma Parrot\cite{electronic:parrot}\cite{electronic:wiki_parrot}. En quadrokopter benytter fire faste rotorer til at
generere opdrift, samt til at styre sin bevægelse i rummet.%\\

AR.Drone blev introduceret i 2010 som ``the Flying Videogame'' og
promoveres stadig af producenten som et stykke legetøj, der fjernstyres fra
brugerens iPhone eller iPad. Det har siden
fundet stor anvendelse, ikke blot som et avanceret stykke
legetøj. Forskere, studerende og hobbyister har taget den fjernstyrede
quadrokopter til sig som en færdig platform til at udvikle videre
ovenpå\cite{electronic:ludep} og som platform til selv at
ombygge.%\cite evt. flere som har brugt AR.Dronen i deres forsøg
        %forskning, bl.a. LUDEP. 

Parrots quadrokopter kommer med et sæt sensorer bestående af to kameraer; et vertikalt 
nedadrettet og et horisontalt fremadrettet, en højdemåler, et gyroskop%(til at måle hældning, krængning og drejning)<- senere detalje, her kun intro
, samt et accelerometer. I 2012 ventes en opdateret udgave af AR.Drone. Den nye version tilføjer yderligere et kamera i høj opløsning (HD),
en trykmåler (digitalt barometer) og et kompas til platformen.

AR.Drone er opbygget som en letvægtskonstruktion af kulfiber, plast og
skummateriale og kommer med to forskellige skumskjold til henholdsvis
indendørs (figur~\ref{fig:indendoersskjold}) og udendørs flyvning (figur~\ref{fig:udendoersskjold}).

\begin{figure}[ht]
\centering
  \subfloat[Indendørsskjold]{
    \label{fig:indendoersskjold}
    \includegraphics[width=0.45\textwidth]{grafik/parrot-ardrone.jpg}
  }
  ~ %add desired spacing between images, e. g. ~, \quad, \qquad etc. (or a blank line to force the subfig onto a new line)
  \subfloat[Udendørsskjold]{
    \label{fig:udendoersskjold}
    \includegraphics[width=0.45\textwidth]{grafik/parrot-ardrone-outdoor.jpg}
  }
  \caption{AR.Drone med indendørs- og udendørsskjold. Figurene er fra AR.Drone Developer Guide\cite{techreport:ardroneDevGuide}}
  \label{fig:ardrone}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     AR.Drone - section
%%%%      + Hardware - subsection
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\subsection{Hardware}
\label{ssec:hardware}
AR.Drone er bygget op omkring et antal sensorer, et antal
aktuatorer og en processorenhed.

\subsubsection{Sensorer}
\begin{figure}[ht]
  \centering
  \includegraphics[width=0.80\textwidth]{grafik/navboard.png}
  \caption{Over- og underside af Navigationsprint til undersiden af AR.Dronen. Navboardet indeholder bl.a. ultralydssensoren. Figurene er fra to internetbutikker \uri{droneparts.de} og \uri{aust-rc-tech.com.au} hvorfra der kan bestilles AR.Drone reservedele.}
  \label{fig:navboard}
\end{figure}
\label{sssec:sensorer}
AR.Drone er som sagt udstyret med to kameraer; et nedadrettet og et fremadrettet.
Det fremadrettede er med en synsvinkel på $93 ^{\circ}$ og består af en CMOS\footnote{Complimentary-Symmetry Metal Oxide Semiconductor, på dansk: en sensor af komplimentær metaloxid halvleder teknologi.}-billedsensor som kan levere $640 \times 480$ billeder, AR.Dronen transmittere dog kun med en opløsning på Quarter Video Graphics Array (QVGA) $320 \times 240$ med en framerate på $15 FPS$.
Det nedadrettede kamera er en CMOS sensor med $64 ^{\circ}$ vinkel, der tager billeder i Quarter Common Intermediate Format (QCIF) $176 \times 144$ opløsning, med en framerate på $60 FPS$.

Til at bestemme AR.Dronens afstand til jorden anvendes en ultrasonisk
afstandsmåler. Denne opererer ved at udsende en ultralydspuls og herefter
måle tidsintervallet der går før ekkoet måles. Ultralydsmåleren er angivet
til at virke op til 6 meter og er rent fysisk placeret på navboardet (se figur \ref{fig:navboard}) på AR.Dronens underside.


AR.Drone er udstyret med to gyroskoper, et 2-akses gyroskop til at
måle hældningsraten om x- og y-aksen (pitch og roll) samt et 1-akses piezoelektrisk gyroskop
til at måle rotationen om z-aksen (yaw). Gyroskoperne kombineres med et
3-akses accelerometer i en samlet enhed til at måle inerti (IMU)\footnote{Inertial Measurement Unit}, denne anvendes til
løbende at give estimater af Euler-vinklerne; theta, phi og psi. Hvor phi og theta er henholdsvis pitch og roll, mens at psi er yaw. For en grafisk repræsentation se evt figur \ref{fig:drone_movements}.

\subsubsection{Aktuatorer}
\label{sssec:aktuatorer}
AR.Dronens aktuatorer er de fire børsteløse $15 Watt$ motorer. Motorerne
arbejder i intervallet $10350$ til $41400$ omdrejninger per minut ($RPM$) og når AR.Dronen står stille i
luften arbejder motorerne med $28000 RPM$. Dette svarer, grundet gearingen,
til $3300 RPM$ for propellerne. Motorerne har uden sammenligning det
største strømforbrug af alle AR.Dronens enheder.

\subsubsection{Den indlejrede computer}
\label{sssec:processor}
Den centrale beregnerenhed på AR.Dronen er en ARM9 $468 MHz$
processor (Parrot 6 ARM926EJ) med $128 Mbyte$ DDR RAM til 
arbejdshukommelse og $128 Mbyte$ NAND flash til persistent (vedvarende) hukommelse.

Til den embeddede computer er der et integreret trådløst netværkskort(Atheros AR6102G-BM2D) til wifi. 

På undersiden af quadrokopteren er der et 7 benet molex-stik til ekstern serialkommunikation. Porten virker bl.a. som en On-The-Go USB-port, der primært anvendes ved opdateringer.

\subsubsection{Strømforsyning}
\label{sssec:forsyning}
Batteriet der driver AR.Dronens enheder er et 3 celle lithium-polymer batteri med en open-circuit\footnote{Open-circuit spændingen er den spænding der er over batteriet når det er uden belastning og ikke oplades.} spænding på $11,1 Volt$, med ladning på $1000$ milli-ampere-timer ($mAh$) og en afladnings hastighed på $10$ Coulomb ($C$). Opladning af batteriet kan foregå i løbet af 90 minutter. Efter sigende skulle batteriet give omking 12 minutters flyvetid\cite{electronic:ar.drone_parrot_technologies}\cite{electronic:wiki_ar.drone}.

\begin{figure}
  \centering
  \includegraphics[width=0.99\textwidth]{grafik/drone_movements.png}
  \caption{(a) vinkelhastigheden $\Omega$ øges med $\Delta_A$ på alle 4 propeller, quadrokopteren øger dermed løftekraften (acceleration i Z-aksen), (b) Vinkelhastigheden øges på venstre og mindskes på højre propel, quadrokopteren laver et ``roll'' til højre (acceleration i Euler-vinklen theta), (c) samme som b, men i pitch (acceleration i euler-vinkel phi) (d) En større vinkelhastighed på de med-uret-drejende propeller gør at torque bliver ulige og at quadrokopteren drejer mod venstre (acceleration i yaw/psi-vinklen). Ved bevægelser frem og tilbage udledes en positiv eller negativ hastighed ($V_x$), ligesom ved bevægelser sideværts ($V_y$). figuren er fra AR.Drone SDK Development guide\cite{techreport:ardroneDevGuide}}
  \label{fig:drone_movements}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     AR.Drone - section
%%%%      - Hardware -
%%%%      + Fysik - subsection
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Quadrokopter fysik}
\label{ssec:fysik}
AR.Dronen fåes som nævnt med 2 skrog eller skjold
(figur~\ref{fig:indendoersskjold}), og vejer 420 gram med det
indendørs skrog monteret. Et pund er en relativ lille vægt, andre
quadrokoptere\cite{quteprints33767} har f.eks. 4-5 kg som de skal
løfte rundt på. 

De 4 propeller sidder i hver sit hjørne af et kulfiberkryds på
AR.Dronen. Når en propel på AR.Dronen rotere om sin akse flytter den
luften i et areal rundt om propellen. Lufttrykket på undersiden af
propellen bliver herved større end lufttrykket på oversiden af
propellen. Hvis AR.Dronen ligger vandret vil forskellen i lufttryk
giver en
Bernoullieffekt\cite{nla.cat-vn856146}%\cite{electronic:wiki_bernoulli} 
 som påvirker AR.Dronen med en kraft modsat tyngdekraften
 (thrust)\cite{electronic:wiki_quadrotor}. Udover thrust påvirker den
 roterende bevægelse også propellens base med et moment (torque)
 modsat propellens retning. Eksempelvis vil en helikopter uden haleror
 dreje ukontrolerbart rundt om sig selv, men fordi AR.Drone har et par
 rotore som drejer een vej (med uret), mens et andet par drejer modsat
 (imod uret)\cite{techreport:ardroneDevGuide}, bliver summen af
 momentpåvirkning nul, hvis de 4 rotere drejer med samme hastighed. 
Denne egenskab bruges til at styre AR.Dronens flyvning og bevægelser i
rummet, som kan beskrives med 3 bevægelsesakser; x, y og z (se
figur~\ref{fig:drone_movements}) som er lokale for quadrokopteren. 

AR.Dronens bevægelser styres ved at kontrollere dens vinkel i forhold
til de 3 akser. Skal AR.Dronen f.eks. flyve fremad, sættes forenden
til at være lidt under bagenden i forhold til det vandrette plan. I
praksis sker det ved at sænke vinkelhastigheden på den forreste propel
samtidig med at omdrejningsantallet øges %spørgsmålet er hvad er
moment påvirkningen af (2*omega_H + delta_A - delta_B) - (2*omega_H)
. . .  på den bageste propel. Det resultere i at AR.Dronen hælder lidt
fremad som på figur \ref{fig:drone_movements}c. Samme princip gør sig
gældende når AR.Dronen skal flytte sig sideværts som på figur
\ref{fig:drone_movements}b.

Hvis AR.Dronen skal dreje om sin egen akse for at kigge længere til
venstre bruges samme egenskab som før; det moment som tilføres af de 2
propeller der drejer med uret skal overstige det moment som tilføres
af de 2 propeller der drejer modsat. Det gøres ved at øge
vinkelhastigheden på de to førstnævnte og sænke hastigheden på de
propeller der drejer modsat uret.

Når AR.Dronen går fra at ligge vandret til istedet at hælde, så
flyttes noget af thrust fra at virke lodret imod tyngdekraften til
også virke sideværts. Det betyder at propellernes samlede
vinkelhastighed skal øges for at opretholde den samme afstand til
jorden. Ifølge SDK DevGuide\cite{techreport:ardroneDevGuide} bør
hældningen på phi og theta ikke overstige $0.52 rad$ ($30 ^{\circ}$)
ellers kan flyvehøjden ikke opretholdes. Den maximale hældning kan
sættes til f.eks. 0.25 radianer via AT-kommandoen i figur
\ref{fig:ateulerangle}.
\begin{figure}
  \begin{framed}
\begin{verbatim}
 AT*CONFIG=605,"control:euler_angle_max","0.25"
\end{verbatim}
  \end{framed}
  \caption{Eksempel på indholdet af en AT-kommandobesked. Beskeden overføres fra klient-enheden til AR.Dronen på UDP-port 5556. Lige netop denne besked sætter en softwarekonstant i AR.Dronens firmware, der bestemmer den maksimalt tilladte hældning på $\Phi$ og $\Theta$.}  
  \label{fig:ateulerangle}
\end{figure}

I styreprogrammet på AR.Dronens computer kan man sætte en konstant (se figur~\ref{fig:ateulerangle}) til at styre den øvre grænse for hvor meget quadrokopteren maximalt kan krænge. Konstanten \emph{ Euler\_angle\_max } virker som en cut-offvinkel, dvs. under flyvning tester AR.Dronen løbende at hverken pitch ($\Phi$)- eller roll ($\Theta$)-vinklen overskrider grænsen. Sker det lukkes systemet ned; kraften til rotorene klippes og AR.Dronen lader sig falde til jorden.
%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     AR.Drone - section
%%%%      - Hardware -
%%%%      - Fysik - 
%%%%      + Software - subsection
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Software}
\label{ssec:software}
AR.Dronens microcomputer kommer med en Linux 2.6.27 kerne
installeret. Det bemærkes at 2.6.27 er den første kerne med indbygget
support for UBIFS\cite{electronic:wiki_ubifs} som er det filsystem der
anvendes på AR.Dronens NAND flashhukommelse.

\subsubsection{Busybox linux platformen på AR.Dronen}
\label{sssec:busybox}
Udover Linux kernen leveres AR.Drone også med
Busybox\cite{electronic:busybox} installeret.  Busybox giver adgang
til en række Unix værktøjer (copy \code{cp}, list \code{ls} osv.)
optimeret til brug i embeddede systemer. Busybox konfigureres så kun
de ønskede værktøjer medtages og disse pakkes så til en enkelt
eksekverbar fil.  Dette betyder at størrelsen holdes på et
minimum. Busybox på AR.Drone fylder $483 kbyte$ og udstyrer AR.Dronen
med alle unix brugerkommandoer man forventer på et standard linux
system, e.g. \code{cd}, \code{ls}, \code{mv}, \code{ln} osv.  Busybox
på AR.Dronen leverer desuden en Dynamic Host Configuration
Protocol\cite{rfc2131} (DHCP) service; den DHCP-server AR.Dronen
anvender til at uddele %DHCP cite?  IP\cite{rfc791}-adresser og lave
et netværk mellem en klient og AR.Dronen selv, samt en
telnet\cite{rfc854}-server der giver adgang til AR.Dronens terminal
%telnet cite?  og en texteditor %(Vi) der gør det muligt at redigere
filer direkte på AR.Dronen.

\subsubsection{Program.elf -- AR.Dronens styreprogram}
\label{sssec:program.elf}
Den firmware der står for selve styringen, transmitteringen af data og
bearbejdning af sensordata i forbindelse med flyvning er implementeret
i \uri{/bin/program.elf}. Da der er tale om proprietært software
betragtes programmet som en lukket kasse uden hensyntagen til
implementeringen, vi kan dog udlede forskellige elementer efter at
have observeret AR.Dronen under flyvning. -- \uri{Program.elf}
indeholder blandt andet
\begin{itemize}
\item en PID controller til at stabilisere AR.Dronen når der svæves,
\item en algoritme til at udlede AR.Dronens hastighed ved hjælp af
  bundkameraet (bekræftes også i en
  artikel\cite{velocity_estimation_inside_the_drone} af Parrot
  selv.)%cite hvor
% nogle siger at program.elf + motorstyring + radio tager op mod $80
% \%$ af processorkraften, passe på med ikke at overforbruge de sidtse 20\%
\item og en algoritme til at detektere tags i billeder i forbindelse
  med augmented reality spil.
\end{itemize}
\uri{Program.elf} modtager kommandoer fra brugeren gennem en User
Datagram Protocol\cite{rfc768} (UDP) port. Kommunikationsinterfacet
mellem bruger og quadrokopteren beskrives i
afsnit~\ref{ssec:kommunikation}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     AR.Drone - section
%%%%      - Hardware -
%%%%      - Fysik -
%%%%      - Software
%%%%      + Klient/server kommunikation - subsection
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Kommunikation mellem AR.Dronen og en klient-enhed}
\label{ssec:kommunikation}
Interaktion med de programmer der kører på AR.Dronens linux-platform kan kategoriseres i 3 grupper:
\begin{itemize}
  \item Som klient (PC, smartphone eller lignende) via Telnet eller
    FTP\cite{rfc959} over trådløst netværk til AR.Dronen, hvor AR.Dronen fungere som server.
  \item Ved at eksekvere en applikation på en klient (PC, smartphone
    eller lignende) der sender og modtager UDP-pakker og
    AT-kommandoer\footnote{AT(tention)-kommandoer over trådløst netværk (gennemgåes nærmere i
      sektion \ref{sssec:atinterface}}) til det kørende firmware
    \uri{program.elf} på AR.Dronen. 
  \item Ved at eksekvere et program der kører
    og kommunikerer internt på AR.Dronen. Programmet kommunikerer med
    AR.Dronens firmware \uri{program.elf} gennem de tre UDP-porte der
    også anvendes ved almindelig trådløs kommunikation.
\end{itemize}

\subsubsection{TCP baseret kommunikation}
\label{sssec:tcp}
Fra en klient-computer er det muligt at få adgang til AR.Dronens 
installerede linuxinstallation ved at oprette en telnetforbindelse til AR.Dronens 
faste IP-adresse (192.168.1.1). Efter at forbindelsen er etableret 
får brugeren her adgang til en rodterminal. %root .. eller?

Ved at oprette forbindelse gennem FTP, fra et FTP-program på en 
ekstern klientcomputer til AR.Dronens FTP-server, kan man overføre 
filer imellem AR.Dronen og klientcomputeren med FTP-protokollens 
PUT og GET kommandoer. Hvis klienten ikke angiver en sti lægges 
overførte filer som standard i \uri{~/data/video} mappen på AR.Dronen.

\subsubsection{UDP baseret kommunikation}
\label{sssec:udp}
I modsætning til FTP- og Telnet-klienterne, som er TCP baserede, anvendes
UDP-protokollen til den kommunikation der sker mellem \uri{program.elf} og
brugerens system, f.eks iPhone eller PC.

Firmwaren \uri{program.elf} på AR.Dronen sender og modtager pakker på tre UDP-porte:
\begin{itemize}
  \item På port 5556 (command port) lytter quadrokopteren efter brugerkommandoer, afsendt fra klientenheden e.g. ``takeoff'', flyv-frem, drej, land osv.
  \item på port 5555 (video port) sender AR.Dronen en videostream til klientenheden.
  \item på port 5554 (video port) sender AR.Drone løbende statusinformation om f.eks. hastighed, eulervinkler, afstand til jorden osv. Pakkerne fra port 5554 kaldes \emph{navdata} fordi pakkerne indeholder information om navigationstilstanden.
\end{itemize}


\subsubsection{AT kommando interface}
\label{sssec:atinterface}
En klientenheden som skal kommunikerer med AR.Dronens \uri{program.elf}, gør dette ved hjælp af
såkaldte attention-kommandoer (AT command). En AT-kommando er basalt set blot en
tekststreng encodet som 8 bits karakterer. AT-kommandoer sendes til AR.Dronens
kommando\-port (5556) som UDP-pakker. Formatet for AT-kommandoer ses på
figur \ref{fig:atsyntaks}.

\begin{figure}
  \begin{framed}   
\begin{verbatim}
 AT*[kommandonavn]=[sekvensnummer],[arg1, arg2 ... argN]<LF>
\end{verbatim}
  \end{framed}
\caption{Syntaksen for en AT-kommando; [kommandonavn] kan f.eks. være
  \code{PCMD}. [sekvensnummer]-heltallet skal være stigende for hver
  ny afsendt AT-besked. Listen med argumenter; [arg1, arg2 ... argN],
  variere i antal afhægig af konteksten. Ved afsending af en
  \code{PCMD}-kommando skal der medsendes 5 talværdier for hhv. flag,
  roll, pitch, gas og yaw.} 
\label{fig:atsyntaks}
\end{figure}

Ved at afsende en kommando som i figur~\ref{fig:ateksempel} bestemmer
man hvorledes AR.Dronen skal bevæge sig ved translation og rotation,
som beskrevet i \titleref{ssec:fysik} sektion \ref{ssec:fysik}. 

\begin{figure}
  \begin{framed}   
\begin{verbatim}
 AT*PCMD=21625,1,0,0,0,0<LF>
\end{verbatim}
  \end{framed}
\caption{Eksempel på en \code{PCMD} AT-kommando. Denne specifikke
  kommando bringer AR.Dronen i hovertilstand. [sekvensnummer]'et er 21625. Listen med argumenter er hhv. flag=1, roll=0, pitch=0, gas=0 og yaw=0.}
\label{fig:ateksempel}   
\end{figure}
%    [kommandonavn] er navnet på den ønskede kommando
%    [sekvensnummer] er et globalt, altid stigende sekvensnummer
%    [arg1, ... argN] er et variende antal parametre

Brugen, syntaksen og betydningen af 7 forskellige AT-kommando navne
beskrives i detaljer i afsnit 6 af AR.Drone Development
Guide\cite{techreport:ardroneDevGuide}. Det skal dog nævnes at
man i reglen skal sikre sig at man vedbliver at sende beskeder
periodisk for at AR.Dronen ikke skal tolke forbindelsen til
klientenheden som tabt. En tabel med AT-kommandoerne kan ses i tabel
\ref{tab:kommandoer} i appendiks \ref{sec:at}. 


\subsection{Vurdering af AR.Dronen som robotplatform}
En elaboreret tekst omkring hvad man kan sige af pro et con omkring AR.Dronen som platform til udvikling af en flyvende robot.

%cite hvor
% nogle siger at program.elf + motorstyring + radio tager op mod $80
% \%$ af processorkraften, passe på med ikke at overforbruge de sidtse 20\%

% flyttes til vurdering af dronen-sektion
%\subsection{begrænsninger} %i et andet sup_sektion..? evt. +ultralydsting
%% Ifølge Wikipedia.org\cite{electronic:wiki_ar.drone} skal AR.Dronen være i stand til at flyve fremad med en maksimal hastighed på $5 m/sek$ svarende til $18 km/t$. %\cite{wikiDrone}
%% Selvom det synes at give mening at beskrive AR.Dronens bevægelser i 3 dimensioner og deri nemmere at bruge accelerometer- og gyro-målinger fra sensorene om bord. Så kan man egentlig ikke sige noget udfra accelerometer og gyroer omkring hvor langt AR.Dronen har fløjet eller med hvilken hastighed AR.Dronen bevæger sig.
%% Vi kan måske udlede estimater for hastigheder ved at integrere over accelerationen, men hastigheden i det horisontale plan er i praksis afhængig af miljøet og kan ikke umiddelbart bestemmes. Roll og pitch værdierne kan være sat til 0 og AR.Dronen vil ligge horisontal, men kan stadig godt bevæge sig sideværts i luften\footnote{AR.Dronen siges at være ``trimmet'' (med en konstant hastighed, evt. 0m/S) hvis den ikke påvirkes af en resulterende kraft og acceleration dermed er 0} på grund af indebåren inerti eller f.eks. en stille konstant vind. Bevæger AR.Dronen sig med en konstant hastighed kan det ikke aflæses af accelerometeret, afstande AR.Dronen har flyttet sig kan således heller ikke aflæses af accelerometer og gyro alene. Firmwaren fra parrot tager istedet bundkameraet til hjælp ved at bruge opticalflow til at udlede hastigheder i planet, man kan således alligevel bede AR.Dronen om et estimat for hastigheden over jorden som en værdi i navdatapakken.


%%  Det er værd at bemærke, at højdemåleren ikke måler
%% højden på et specifikt punkt, men derimod returnerer den mindste højde
%% i et område som det på figur \ref{fig:sonicbeam}, samt at ultrasoniske
%% detektorer generelt har problemer med bløde og skrånende overflader%cite?.
%% \begin{figure}[ht]
%%   \centering
%%   \includegraphics[width=0.80\textwidth]{grafik/sonardzone.jpg}
%%   \caption{Udbredelsesområde for ultralydssensorsignal, man ser at afstanden ikke nødvendigvis er vinkelret på sensoren idet der kan forekomme ekko fra et større område under sensoren (figuren er fra \uri{http://picaxe.hobbizine.com/srf05.html}).}
%%   \label{fig:sonicbeam}
%% \end{figure}


%%% flyttes til sektion med vurdering af dronen
%Sammenlignet med TCP opererer UDP med noget mindre
%overhead per afsendt besked. Tilgengæld garanterer protokollen intet
%om hvorvidt eller hvornår en pakke når frem til sin destination.

% UDP
%er oftest det første valg, når der skal streames video og lyd over et
%netværk, da en enkelt mistet pakke sjældent har stor betydning i denne
%kontekst. Når fokus er på at få sendt så meget
%information (navigationsdata og video) som muligt til brugeren, giver
%det god mening at anvende UDP og så implementere et minimum af
%flowkontrol ovenpå protokollen, e.g.  

%Til gengæld kan vi godt se fordele i
%de garantier TCP kunne give når fokus er på at modtage kontrolpakker,
%heldigvis er det forholdsvis simpelt, at kontrollere hvorvidt visse
%kritiske beskeder(land, let etc.) er nået frem til AR.Dronen, eller om vi
%skal sende pakken igen.


\section{Introduktion til styring af AR.Drone med Python}
\subsection{AT-kommando Python interface}
Ved hjælp af AT-kommandoerne definerer AR.Dronen et interface til
enheder der er indenfor rækkevidde af dens trådløse netværk. For at
gøre dette AT-interface mere praktisk anvendeligt har vi videreudviklet
på en python-wrapper \cite{electronic:venthur}. Vi har implementeret
interfacet som en Python tråd der løbende sender kommandoer til
AR.Dronen, hvilket betyder at vores system ikke afhænger af at alle
UDP-pakker når deres destination. %think I understand but humor me and elaborate...
 Ved at sende al kontrolkommunikation
gennem interfacet, behøves vi ikke at tænke på deltaljer som
sekvensnumre og watchdog-beskeder, da disse håndteres transparent af
systemet.  
Vores interface(\todo{REF TIL EGEN KODE}) definerer en række metoder til at
kontrollere dronens opførsel og bevægelser. Interfacet kan i det
simpleste tilfælde anvendes direkte fra Pythons interpreter, men
fungerer også som en del af vores større system.

\subsection{Eksempel på anvendelse af Python interface til AR.Dronen}
Et simpelt eksempel på anvendelse af vores kontrolinterface gives ved at
starte pythons fortolker, importere examples-modulet og herefter
afvikle en metode indeholdende kommandoer til
AR.Dronen. Fremgangsmåden ses på figur~\ref{fig:pythoninterpex}.

\begin{figure}[ht]
  \begin{framed}   
    \begin{verbatim}
>>> import examples as e
>>> e.square()
    \end{verbatim}
  \end{framed}
\caption{Import og afvikling af simpelt kontrolinterface-eksempel i pythonfortolkeren}
\label{fig:pythoninterpex}
\end{figure}

Metoden \code{square()} der kaldes i eksemplet i figur~\ref{fig:pythoninterpex},
lader AR.Dronen lette, flyve rundt i en firkant og for herefter at
lande igen(under antagelse af at klientcomputeren er forbundet med AR.Dronens
trådløse netværk). Bevægelsesmønstret opnåes ved at der kaldes en
metode(take\_off, move eller land) på kontrolinterfacet, hvorefter der er en pause
før den næste metode kaldes. Metodekaldende oversættes af interfacet til
AT-kommandoer og sendes så som UDP-pakker til AR.Dronens
kommandoport. Den konkrete implementation af \code{square()} ses i
figur~\ref{fig:pythonimpl1}. Det bemærkes at kontrolinterfacetråden
skal startes (kald af \code{c.start()}) før kommandoerne har nogen effekt.

Beskrivelse af selve flyvningen...

\begin{figure}[ht]
  \lstset{language=Python, frame=single}
  \begin{lstlisting}
def square():
    import controllers
    import time

    c = controllers.ControllerInterface()
    c.start()

    print 'taking off'
    c.take_off()
    time.sleep(5.0)
    print 'moving Forward'
    c.move(0.0, 0.2, 0.0, 0.0, True)
    time.sleep(2.0)
    print 'moving right'
    c.move(0.2, 0.0, 0.0, 0.0, True)
    time.sleep(2.0)
    print 'moving back'
    c.move(0.0, -0.2, 0.0, 0.0, True)
    time.sleep(2.0)
    print 'moving left'
    c.move(-0.2, 0.0, 0.0, 0.0, True)
    time.sleep(2.0)
    print 'landing'
    c.land()

    c.stop()
\end{lstlisting}
\caption{Python implementation der importerer og anvender vores kontrolinterface til en
  simpel flyvning}
\label{fig:pythonimpl1}
\end{figure}

\section{Brugerens interaktionsmuligheder med systemet}
For at gøre styringen af dronen anvendelig i praksis har vi
implementeret softwaremoduler til at tage mod input fra brugeren. Vi
har tre input muligheder: En keyboardcontroller der lytter efter input
fra tastaturet, en joystickcontroller der er tilknyttet en Xbox360
controller samt en autocontroller der kan initiere og afslutte givne
opgaver. Vi har mulighed for at starte systemet op med alle
controllere på samme tid, eller undlade en eller flere. Under
udviklingen af systemet har vi oftest anvendt alle tre controllere på
samme tid, da de komplimenterer hinanden, for eksempel kan man godt
anvende autocontrolleren for sig selv, men i det tilfælde at noget
skulle gå galt i udførslen af en opgave, har man ingen mulighed for at
bringe AR.Dronen manuelt ned.

\subsection{Joystickcontroller}
Joystickcontrolleren står i vores system istedet for en iPhone eller
iPad, den anvendes til at fjernstyre AR.Drone manuelt i forbindelse
med testflyvninger. Fjernstyringsdelen fungerer ved at oversætte
værdier fra Xbox360 controlleren og så sende disse til
controlinterfacet. Joystickcontrolleren kan desuden anvendes til at
starte prædefinerede opgaver på autocontrolleren, således kan piloten
manuelt bringe AR.Dronen i en given position for herefter at starte
den automatiske afvikling af et forudbestemt bevægemønster

\section{Optisk flow navigation}
Lidt omkring hvordan man kan detekte at man er i en lang koridor. Plus nogle referencer til andre hvorfra vi har fået inspiration.

\begin{figure}
  \centering
  \includegraphics[width=0.40\textwidth]{grafik/polar2cartesian.png}
  \caption{En linie beskrevet ved det velkendte almindelige cartesisk koordinatsystem som: $y=ax+b$, samme linie beskrevet i polar koordinatsystem ved en vinkel $\Theta$ og en afstand $\rho$.
}
  \label{fig:polar2cartesian}
\end{figure}

That is it maybe


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     Resultater - section
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Resultater}

\pagebreak


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%%     Konklusion - section
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Konklusion}

\pagebreak


\appendix

\bibliographystyle{abbrv}
\bibliography{referencer}

\section{Appendix header A}

\section{AT kommandoer}
\label{sec:at}
Kort fortalt så må en AT-kommando ikke deles i flere pakker, men en UDP-pakke kan
indeholde flere AT-kommandoer, kommandoerne skal blot være adskilt med
en "linefeed" karakter og den samlede længde må ikke overskride 1024
karakterer. Såfremt en kommando overskrider længdebegrænsningen eller
på anden måde ikke overholder syntaksen, vil AR.Dronen ignorere
kommandoen.   

Tabel \ref{tab:kommandoer} viser hvilke kommandoer der
jf. \cite{techreport:ardroneDevGuide} kan bruges til at
kontrollere AR.Dronen.

\begin{table}[ht]
  \begin{center}
  \begin{tabular}{ l | p{3,5cm} | p{5,5cm} }
    Navn & Argumenter & beskrivelse\\
    \hline
    REF & input & Kommando til takeoff, land og nødstop\\
    \hline
    PCMD & flag, roll, pitch, gas, yaw & Flytter AR.Dronen\\
    \hline 
    FTRIM &  & Sætter den horisontale referenceværdi \\
    \hline
    CONFIG & key, value & Ændrer en konfigurationsparameter\\
    \hline
    LED & animation, frequency, duration & Viser en LED animation\\
    \hline
    ANIM & animation, duration & Afspiller en flyvesekvens\\
    \hline
    COMWDG & & Resetter komunikationstimeren
  \end{tabular}
  \end{center}
  \caption{Gyldige AT-kommandoer} 
  \label{tab:kommandoer}
\end{table} 



\end{document}

%\begin{center}
%  \includegraphics[scale=0.35]{pic/selfserv.jpg}
%\newline
%\textbf{Figur 1}
%\end{center}
%\lstinputlisting[language=Python]{../drone.py}
