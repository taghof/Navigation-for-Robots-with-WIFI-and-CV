%\documentclass[12pt,a4paper,twoside,openright,fleqn]{memoir}
\documentclass[10pt]{article}
\usepackage[danish]{babel}
\usepackage[ansinew]{inputenc}
\usepackage{graphicx}
\usepackage{framed}
\usepackage{subfig}
\usepackage{listings}
\usepackage{natbib}
\usepackage{titleref}

\begin{document} 
\newenvironment{nb}
   {\begin{framed}\begin{quotation}}
   {\end{framed}\end{quotation}}
%\newcommand{\oversaet}[1]{(\textit{#1})}
\newcommand{\uri}[1]{#1}

\title{Master Thesis}
\author{Thomas Thyregod 20051688\\ Morten Daugaard 20051715\\ \texttt{ tysse, taghof }@cs.au.dk\\\\ Department of Computer Science, University of Aarhus\\ Aabogade 34, 8200 Aarhus N, Denmark\\\\
\hline\\
\vspace{4cm}\\
\makeatletter
\texttt{Semi Autonomous Navigation}\\
\texttt{for Arial Robots}\\
\vspace{4cm}\\
\hline\\
}
\date{\today}
\maketitle
\newpage

\pagestyle{headings}

\section*{Resume Abstrakt}

\pagebreak

\tableofcontents

\pagebreak

\section{Introduktion}
\subsection{området, teknologi}
%\subsection{}
%\subsection{}

\pagebreak
\section{AR.Drone}
AR.Drone er en quadrocopter fremstillet og udviklet af det franske
firma Parrot. En quadrocopter benytter fire faste rotorer til at
generere opdrift, samt til at styre sin bevægelse i rummet. 
\\AR.Drone blev introduceret i 2010 og har siden fundet stor anvendelse, ikke
blot som et stykke avanceret legetøj, men også som en
udviklingsplatform til forskere og studerende. En AR.Drone kommer med et
sæt sensorer bestående af to kameraer(et vertikalt nedadrettet og et
horisontalt fremadrettet), en højdemåler, gyroskop(til at måle
hældning, krængning og drejning), samt et accelerometer. I 2012 ventes
en opdateret udgave af AR.Drone, denne forventes at tilføje HD kamera,
trykmåler og kompas til platformen.
\\AR.Drone er opbygget som en letvægtskonstruktion af kulfiber, plast og
skummateriale og kommer med to forskellige skumskjold til henholdsvis
indendørs og udendørs flyvning.

\begin{figure}[ht]
\centering
  \subfloat[Indendørsskjold]{
    \label{fig:indendoersskjold}
    \includegraphics[width=0.45\textwidth]{grafik/parrot-ardrone.jpg}
  }
  ~ %add desired spacing between images, e. g. ~, \quad, \qquad etc. (or a blank line to force the subfig onto a new line)
  \subfloat[Udendørsskjold]{
    \label{fig:udendoersskjold}
    \includegraphics[width=0.45\textwidth]{grafik/parrot-ardrone-outdoor.jpg}
  }
  \caption{AR.Drone med indendørs- og udendørsskjold}
  \label{fig:ardrone}
\end{figure}
 
\subsection{Hardware}
\label{ssec:hardware}
Som de fleste robotter består AR.Drone af et antal sensorer, et antal
aktuatorer og en styringsenhed. 
\subsubsection{Sensorer}
\label{sssec:sensorer}
AR.Drone er udstyret med to kameraer, det fremadrettede er en $93 ^{\circ}$
CMOS sensor som kan levere $640 \times 480$ billeder (selvom
resourceknaphed gør at opløsningen der transmitteres fra dronen
kun er $320 \times 240$ (QVGA)) med en framerate på $15 FPS$. Det nedadvendte kamera er
en $64 ^{\circ}$ CMOS sensor, der tager billeder i $176 \times 144$ (QCIF) med en
framerate på $60 FPS$.
\\Til at bestemme dronens højde over jorden anvendes en ultrasonisk
højdemåler, denne opererer ved at udsende en ultralydspuls og herefter
måle tidsintervallet der går før ekkoet måles. Højdemåleren er angivet
til at virke op til 6 meter og er rent fysisk placeret på
dronens navboard. Det er værd at bemærke, at højdemåleren ikke måler
højden på et specifikt punkt, men derimod returnerer den mindste højde
i et område som det på figur \ref{fig:sonicbeam}, samt at ultrasoniske
detektorer generelt har problemer med bløde og skrånende overflader.
\begin{figure}[ht]
  \centering
  \includegraphics[width=0.80\textwidth]{grafik/sonardzone.jpg}
  \caption{Udslagsområde for en ultrasonisk sensor}
  \label{fig:sonicbeam}
\end{figure}
AR.drone er udstyret med to gyroskoper, et 2-akses gyroskop til at
måle hældningsraten om x- og y-aksen samt et piezoelektrisk gyroskop
til at måle rotationen om z-aksen. Gyroskoperne kombineres med et
3-akses accelerometer i en samlet IMU-enhed, denne anvendes til
løbende at give estimater af Euler-vinklerne(theta, phi og psi).  
\subsubsection{Aktuatorer}
\label{sssec:aktuatorer}
Dronens aktuatorer er de fire børsteløse $15 W$ motorer. Motorerne
arbejder i intervallet $10350$ til $41400 RPM$ og når dronen står stille i
luften arbejder motorerne med $28000 RPM$. Dette svarer, grundet gearingen,
til $3300 RPM$ for propellerne. Motorerne har uden sammenligning det
største strømforbrug af alle dronens enheder.
\subsubsection{Styring}
\label{sssec:styring}
Den centrale styringsenhed på dronen er en ARM9 468 mHz
processor(Parrot 6 ARM926EJ) med 128 mb DDR ram og et integreret
trådløst netværkskort(Atheros AR6102G-BM2D). Enheden giver også adgang
til en On-The-Go USB port som primært anvendes ved opdateringer.
\\Batterierne der driver alle enhederne er af lithium-polymer typen og
giver ifølge dokumentationen ca. 12 minutters flyvetid.
  
\subsection{Software}
\label{ssec:software}
\subsubsection{Linux}
\label{sssec:linux}
Dronens microcomputer kommer med en Linux 2.6.27 kerne
installeret. Det bemærkes at 2.6.27 er den første kerne med indbygget
support for UBIFS som er det filsystem der anvendes på dronens
flashmemory.
\subsubsection{Busybox}
\label{sssec:busybox}
Udover Linux kernen leveres AR.Drone også med Busybox installeret.
Busybox giver adgang til en række unix værktøjer der er optimeret til
brug i embeddede systemer og er derfor et meget populært valg blandt
udviklere af sådanne systemer. Busybox konfigureres så kun de ønskede
værktøjer medtages og disse pakkes så til en enkelt eksekverbar fil,
dette betyder at størrelsen holdes på et minimum. Busybox på AR.Drone
fylder 483 kb og udstyrer dronen med alle de userspacer værktøjer man
forventer på et standard linux system(cd, ls, mv, ln osv.), men
leverer desuden også den dhcp-server dronen anvender til at uddele
ip-adresser, den telnet-server der giver adgang til dronens terminal
samt den editor(vi) der gør det muligt at redigere filer på dronen. 
\subsubsection{Program.elf}
\label{sssec:program.elf}
Den firmware der står for selve styringen, transmitteringen af
data og bearbejdning af sensordata i forbindelse med flyvning er
implementeret i \uri{/bin/program.elf}. Da der er tale om proprietært
software kan vi ikke udtale os om hvordan programmet er implementeret,
vi kan dog udlede forskellige elementer efter at have observeret
dronen under flyvning. Program.elf indeholder blandt andet en PID
controller til at stabilisere dronen når der svæves, en algoritme
til at udlede dronens hastighed ved hjælp af bundkameraet%cite hvor
% nogle siger at program.elf + motorstyring + radio tager op mod $80
% \%$ af processorkraften, passe på med ikke at overforbruge de sidtse 20\%
og en algoritme til at detektere tags i billeder i forbindelse med augmented
reality spil. Program.elf modtager kommandoer fra brugeren gennem en UDP port, selve UDP
interfacet beskrives i afsnit~\ref{ssec:kommunikation}.

\subsection{Kommunikation}
\label{ssec:kommunikation}
Kommunikationen med dronen kan indeles i to kategorier, den der
beskæftiger sig med input til, og output, fra program.elf(flyvning) og
den der omhandler den almindelige anvendelse af dronens linux
system.
\subsubsection{TCP baseret kommunikation}
\label{sssec:tcp}
For at få adgang til en terminal på dronen anvendes
en telnetklient. Efter forbindelse til dronens ip-adresse får brugeren
adgang til en rodterminal, da systemet er sat op som et
enkeltbrugersystem.
\\For at overføre en fil til dronen anvendes en FTP-klient. Efter
forbindelse til dronen, kan filer overføres mellem dronen og brugerens
system med FTP-protokollens PUT og GET kommandoer. Hvis der ikke
angives en sti lægges overførte filer som standard i '/data/video' mappen.  
\subsubsection{UDP baseret kommunikation}
\label{sssec:udp}
I modsætning til FTP- og telnetklienterne, som er TCP baserede, anvendes
UDP-protokollen til den kommunikation der sker mellem program.elf og
brugerens system. Sammenlignet med TCP opererer UDP med noget mindre
overhead per afsendt besked, tilgengæld garanterer protokollen intet
om hvorvidt eller hvornår en pakke når frem til sin destination. UDP
er oftest det første valg når der skal streames video og lyd over et
netværk, da en enkelt mistet pakke sjældent har stor betydning i denne
kontekst. Når fokus er på at få sendt så meget
information(navigationsdata og video) som muligt til brugeren, giver
det god mening at anvende UDP og så implementere et minimum af
flowkontrol ovenpå protokollen. Til gengæld kan vi godt se fordele i
de garantier TCP kunne give når fokus er på at modtage kontrolpakker,
heldigvis er det forholdsvis simpelt, at kontrollere hvorvidt visse
kritiske beskeder(land, let etc.) er nået frem til dronen, eller om vi
skal sende pakken igen. 
\subsubsection{AT kommando interface}
\label{sssec:atinterface}
En bruger applikation kommunikerer med dronens software ved hjælp af
såkaldte AT-kommandoer, En AT-kommando er basalt set blot en
tekststreng encodet som 8 bits karakterer, kommandoer sendes til dronens
kommandoport(5556) som UDP-pakker. Formatet for AT-kommandoer ses på
figur \ref{fig:atsyntaks}.
\begin{figure}[ht]
  \begin{framed}   
  \begin{quotation}
    AT*[kommandonavn]=[sekvensnummer][arg1, arg2 ... argN]\newline \newline
    [kommandonavn] er navnet på den ønskede kommando\newline
    [sekvensnummer] er et globalt, altid stigende sekvensnummer\newline
    [arg1, ... argN] er et variende antal parametre
  \end{quotation}
  \caption{AT-kommando syntaks}  
  \label{fig:atsyntaks}
\end{framed}   
\end{figure}

En kommando må ikke deles i flere pakker, men en UDP-pakke kan
indeholde flere AT-kommandoer, kommandoerne skal blot være adskilt med
en "linefeed" karakter og den samlede længde må ikke overskride 1024
karakterer. Såfremt en kommando overskrider længdebegrænsningen eller
på anden måde ikke overholder syntaksen, vil dronen ignorere
kommandoen.   
Tabel \ref{tab:kommandoer} viser hvilke kommandoer der
jf. \cite{ardroneDevGuide} kan bruges til at
kontrollere dronen.\newline 
\begin{table}[ht]
  
  \begin{center}
  \begin{tabular}{ l | p{3,5cm} | p{5,5cm} }
    Navn & Argumenter & beskrivelse\\
    \hline
    REF & input & Kommando til takeoff, land og nødstop\\
    \hline
    PCMD & flag, roll, pitch, gas, yaw & Flytter dronen\\
    \hline 
    FTRIM &  & Sætter den horisontale referenceværdi \\
    \hline
    CONFIG & key, value & Ændrer en konfigurationsparameter\\
    \hline
    LED & animation, frequency, duration & Viser en LED animation\\
    \hline
    ANIM & animation, duration & Afspiller en flyvesekvens\\
    \hline
    COMWDG & & Resetter komunikationstimeren
  \end{tabular}
  \end{center}
  \caption{Gyldige AT-kommandoer} 
  \label{tab:kommandoer}
\end{table} 

\subsection{Fysik}
\label{ssec:fysik}
AR.Dronen har 4 rotorvinger (propeller) siddende i hver sit hjørne af et kulfiberkryds
på dronen. 

Når en propel på dronen rotere om sin akse flytter den luften i et areal rundt om propellen. Lufttrykket på undersiden af propellen bliver herved større end lufttrykket på oversiden af propellen. Hvis dronen ligger vandret vil forskellen i lufttryk giver en Bernoullieffekt som påvirker dronen med en kraft modsat tyngdekraften (thrust). Udover thrust påvirker den roterende bevægelse også propellens base med et moment (torque) modsat propellens retning. Eksempelvis vil en helikopter uden haleror dreje ukontrolerbart rundt om sig selv, men fordi AR.Drone har et par rotore som drejer een vej (med uret), mens et andet par drejer modsat (imod uret)\cite{ardroneDevGuide}, bliver summen af momentpåvirkning nul, hvis de 4 rotere drejer med samme hastighed.
Denne egenskab bruges til at styre dronens flyvning og bevægelser i rummet, som kan beskrives med 3 bevægelsesakser (x, y og z).

Dronens bevægelser styres ved at kontrollere dens vinkel i forhold til de 3 akser. Skal dronen f.eks. flyve fremad, sættes forenden til at være lidt under bagenden i forhold til det vandrette plan. I praksis sker det ved at sænke vinkelhastigheden på den forreste propel samtidig med at omdrejningsantallet øges %spørgsmålet er hvad er moment påvirkningen af  (2*omega_H + delta_A - delta_B) - (2*omega_H) . . .
 på den bageste propel. Det resultere i at dronen hælder lidt fremad som på figur \ref{fig:drone_movements}c. Samme princip gør sig gældende når dronen skal flytte sig sideværts som på figur \ref{fig:drone_movements}b.

Hvis dronen skal dreje om sin egen akse for at kigge længere til venstre bruges samme egenskab som før; det moment som tilføres af de 2 propeller der drejermed uret skal overstige det momentet som tilføres af de to propeller der drejer modsat. Det gøres ved at øge vinkelhastigheden på de to førstnævnte og sænke hastigheden på de propeller der drejer modsat uret.

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.99\textwidth]{grafik/drone_movements.png}
  \caption{Drone thrust, torque og bevægelser}
  \label{fig:drone_movements}
\end{figure}

Når dronen går fra at ligge vandret til istedet at hælde, så flyttes noget af thrust fra at virke lodret imod tyngdekraften til også virke sideværts. Det betyder at propellernes samlede vinkelhastighed skal øges for at opretholde den samme afstand til jorden. Ifølge SDK DevGuide\cite{ardroneDevGuide} bør hældningen på phi og theta ikke overstige $0.52 rad$ ($30 ^{\circ}$) ellers kan flyvehøjden ikke opretholdes. Den maximale hældning kan sættes til f.eks. 0.25 radianer via AT-kommandoen i figur \ref{fig:ateulerangle}.

\begin{figure}[ht]
  \begin{framed}   
    \begin{quotation}
      AT*CONFIG=605,"control:euler\_angle\_max","0.25"
    \end{quotation}
    \caption{AT-kommando til at sætte max hældning på $\Phi$ og $\Theta$}  
    \label{fig:ateulerangle}
  \end{framed}
\end{figure}

Der er en øvre grænse for hvor meget dronen max kan krænge \emph{ Euler\_angle\_max } virker som en cut-offvinkel, dvs. under flyvning tester dronen løbende at hverken pitch- eller roll-vinklen overskrider grænsen. Sker det lukkes systemet ned; kraften til rotorene klippes og dronen lader sig falde til jorden.\\
%

%\subsection{begrænsninger} %i et andet sup_sektion..?
Ifølge Wikipedia.org\footnote{Wikipedia.org/wiki/Parrot\_AR.Drone, set april 2012} skal dronen være i stand til at flyve fremad med en maksimal hastighed på $5 m/sek$ svarende til 18 km/t. %\cite{wikiDrone}
Selvom at det synes at give mening at beskrive dronens bevægelser i 3 dimensioner og deri nemmere at bruge accelerometer- og gyro-målinger fra sensorene ombord. Så kan vi egentlig ikke sige noget udfra accelerometer og gyroer omkring hvor langt dronen har fløjet eller med hvilken hastighed dronen bevæger sig.
Vi kan måske udlede estimater for hastigheder ved at integrere over accelerationen, men hastigheden i det horisontale plan er i praksis afhængig af miljøet og kan ikke umiddelbart bestemmes. Roll og pitch værdierne kan være sat til 0 og dronen vil ligge horisontal, men kan stadig godt bevæge sig sideværts i luften\footnote{Dronen siges at være ``trimmet'' (med en konstant hastighed, evt. 0m/S) hvis den ikke påvirkes af en resulterende kraft og acceleration dermed er 0} på grund af indebåren inerti eller f.eks. en stille konstant vind. Bevæger dronen sig med en konstant hastighed kan det ikke aflæses af accelerometeret, afstande dronen har flyttet sig kan således heller ikke aflæses af accelerometer og gyro alene. Firmwaren fra parrot tager istedet bundkameraet til hjælp ved at bruge opticalflow til at udlede hastigheder i planet, man kan således alligevel bede dronen om et estimat for hastigheden over jorden som en værdi i navdatapakken.

\pagebreak

\appendix

\bibliographystyle{abbrv}
\bibliography{referencer}

\section{Appendix header A}


\end{document}

%\begin{center}
%  \includegraphics[scale=0.35]{pic/selfserv.jpg}
%\newline
%\textbf{Figur 1}
%\end{center}
%\lstinputlisting[language=Python]{../drone.py}
